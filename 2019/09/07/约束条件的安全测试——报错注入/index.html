<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>约束条件的安全测试_报错注入 | 人间且慢行</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><meta name="referrer" content="no-referrer-when-downgrade"><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">约束条件的安全测试_报错注入</h1><a id="logo" href="/.">人间且慢行</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">约束条件的安全测试_报错注入</h1><div class="post-meta">Sep 7, 2019<span> | </span><span class="category"><a href="/categories/安全/">安全</a></span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#基于约束的SQL攻击"><span class="toc-number">1.</span> <span class="toc-text">基于约束的SQL攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#例题：SKCTF"><span class="toc-number">1.1.</span> <span class="toc-text">例题：SKCTF</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#报错注入"><span class="toc-number">2.</span> <span class="toc-text">报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#其他报错函数"><span class="toc-number">2.1.</span> <span class="toc-text">其他报错函数</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="基于约束的SQL攻击"><a href="#基于约束的SQL攻击" class="headerlink" title="基于约束的SQL攻击"></a>基于约束的SQL攻击</h1><p>假设我们要做一个登录入口</p>
<p>创建数据表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> auto_increment,//<span class="keyword">id</span>是<span class="built_in">int</span>型，非空，自增</span><br><span class="line">username <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">primary <span class="keyword">key</span>(<span class="keyword">id</span>));</span><br></pre></td></tr></table></figure>

<p>注册</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span>(<span class="string">''</span>,<span class="string">'admin'</span>,<span class="string">'123456789'</span>);</span><br></pre></td></tr></table></figure>

<p>攻击</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> <span class="keyword">values</span>(<span class="string">''</span>,<span class="string">'admin                            1'</span>,<span class="string">'1111'</span>);</span><br><span class="line">//username字段没有做好约束</span><br></pre></td></tr></table></figure>

<p>注册的本质就是一个insert（数据库插入一条数据）的过程，刚开始需要加一个管理员账户，账号设置为admin，密码123456789</p>
<p>常见的注入点是：<br>select * from user where username = ‘admin’ and password = ‘123456789’<br>其中账号和密码位置是输入的数据，如果能在表中查到相应数据，就会认为是合法的，用户就可以登录。<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190908/zf2D547WpQ.png" alt="1"></p>
<p>可以看到图中admin后面加上空格仍然可以查询到数据，这里会省略掉后面的空格（这个也不是什么大问题），真正的问题是username长度是有限制的30位（超过的会被消除掉，只会留下前30位），插入的时候会先查看数据在表中存不存在，假设插入了一个31位的数据，他会把这个31位的数据往表里去插。<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190908/4H4TxYdjCm.png" alt="2"></p>
<p>它没有把username字段变成唯一字段，由此会造成你可以插入多个同为admin的用户名</p>
<p>此时可以用admin，1111登陆，问题在于username字段没有做好约束</p>
<h2 id="例题：SKCTF"><a href="#例题：SKCTF" class="headerlink" title="例题：SKCTF"></a>例题：SKCTF</h2><p><a href="https://ctf.bugku.com/challenges#login1(SKCTF)" target="_blank" rel="noopener">例题 BUGku</a>中的  <strong>login1(SKCTF)</strong></p>
<p>注册账号<br>先注册一个号，发现提示只有管理员才可以获得flag，思路：看cookie，session登陆框存在注入等等，发现它没有cookie，可能不是一个真的登陆，因为知道它是SQL约束攻击所以直接尝试</p>
<p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190908/iyGjp54w6X.png" alt="6"><br>猜测账号admin，注册<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190908/ASFJ367rbe.png" alt="3"><br>注册成功<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190908/tb7sQBPmpr.png" alt="4"></p>
<p>登陆<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190908/5TjMjYnPkB.png" alt="5"></p>
<hr>
<h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><p>公式：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span>(select 1 <span class="keyword">from</span>(select</span><br><span class="line">count(*),concat(user(),floor(rand(0)<span class="number">*2</span>)x <span class="keyword">from</span></span><br><span class="line">information_schema.tables<span class="built_in"> group </span>by x)a)</span><br></pre></td></tr></table></figure>

<p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/z5kj4sNZ8p.png" alt="7"></p>
<p><strong>相关函数：</strong></p>
<p>RAND()<br>RAND(N) ：<br>返回在范围0到1.0内的随机浮点值。<br>如果一个整数参数N被指定，它被用作种子值。<br>每个种子产生的随机数序列是不同的 </p>
<p>floor()：向下取整</p>
<p>concat(str1,str2…)：    将多个字符串合并为一个字符串</p>
<p>rand()函数生成0-1的函数，使用floor函数想下取整，值是固定的”0”,我们将rand*2，得到的就是不固定的”0“或”1“</p>
<p>User() ： 是取得 当前登陆的用户</p>
<p>GROUP表示分组，BY后面写字段名，就表示根据哪个字段进行分组</p>
<p>concat（user，rand(0)*2）：user（）与0或1拼接只会出现2种结果<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/ZykrKcbsWk.png" alt="8"><br>这个是对上面语句进行简化，把整个结果分为0和1两种情况</p>
<p>table1,2,3数据量为1,2,3条，1条数据是不报错的，2，3条随机报错，这里报错与数据量有关系，而上面的information_schema.table表mysql默认存在，数据量是特别大的。</p>
<p>数据量很大的表，此时rand函数括号里加0的话它是必然报错的，不加0是随机报错</p>
<p><code>select floor(rand(0)*2) from information_schema.tables</code></p>
<p>不加0随机显示，加0 前几位固定显示</p>
<p><code>select count(*) from information_schema.tables group by floor(rand()*2)</code></p>
<p>不加0:<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/F8zWFafJ3j.png" alt="9"><br>加0 ：<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/X8CCpAFzMt.png" alt="10"><br>这里要理解到：报错的原因一是与数据量有关。二是与rand函数有关，rand的本质是产生01序列，与这个顺序也是有关系的</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">group by </span><br><span class="line">例如：按照<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>分组，就是统计<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>出现次数 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">group by floor(rand(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line"><span class="comment">//返回结果（0，1），如果直接写1是不可以的，它认为是一个常量</span></span><br></pre></td></tr></table></figure>

<p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/hQZS33y2Tk.png" alt="11"><br>本质是统计0和1的个数</p>
<p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/pSyZSd8YYM.png" alt="12"><br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/Tm82CyrnMh.png" alt="13"><br>这样的话要使用rand（加0）报错的时候最小数据要求为3条<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/xQPMRSGWet.png" alt="14"><br>假设数据是0101<br>两次查询的时候生成0，插入时候生成1此时两条数据就会报错（这里只要值一样就行，这里只是用0和1来代替容易理解）</p>
<h2 id="其他报错函数"><a href="#其他报错函数" class="headerlink" title="其他报错函数"></a>其他报错函数</h2><p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/tGPnDTaZ2G.png" alt="15"></p>
<p>有些报错函数有局限性，使用时需要有选择的<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190909/B5Q3FhCCbE.png" alt="16"></p>
</div><div class="tags"><a href="/tags/web安全-ctf/">web安全 ctf</a></div><div class="post-nav"><a class="pre" href="/2019/09/10/基于时间盲注的部分相关函数/">基于时间盲注的部分相关函数</a><a class="next" href="/2019/09/05/宽字节注入/">宽字节注入</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/信安之路/">信安之路</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础知识/">基础知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/web安全-ctf/" style="font-size: 15px;">web安全 ctf</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/计算机网络/" style="font-size: 15px;">计算机网络</a> <a href="/tags/博客搭建/" style="font-size: 15px;">博客搭建</a> <a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/基础/" style="font-size: 15px;">基础</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/04/3.代码执行与命令执行/">代码执行与命令执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/20/2.文件包含/">文件包含</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/15/1.文件上传/">文件上传</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/14/desc相关例题/">desc相关注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/13/order by/">order by，insert相关注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/12/bool型盲注/">bool型盲注</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/基于时间盲注的部分相关函数/">基于时间盲注的部分相关函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/07/约束条件的安全测试——报错注入/">约束条件的安全测试_报错注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/05/宽字节注入/">宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/03/集合和映射/">集合和映射</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a target="_blank"></a><ul></ul><a target="_blank"></a><ul></ul><a target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">人间且慢行.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zindex="-2" count="50" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>